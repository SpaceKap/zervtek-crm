"use client";

import { useState, useRef, useEffect, useCallback } from "react";
import { useSearchParams } from "next/navigation";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { CombinedInvoicesView } from "./CombinedInvoicesView";
import { AddTransactionDialog } from "./AddTransactionDialog";
import {
  TransactionDirection,
  TransactionType,
  UserRole,
} from "@prisma/client";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { ShippingStage, DocumentCategory } from "@prisma/client";
import { format } from "date-fns";

interface FinancialOperationsViewProps {
  currentUser: {
    id: string;
    role: UserRole;
  };
}

interface Transaction {
  id: string;
  direction: TransactionDirection;
  type: TransactionType;
  amount: string;
  currency: string;
  date: string;
  description: string | null;
  vendor: { id: string; name: string } | null;
  customer: { id: string; name: string; email: string | null } | null;
  vehicle: {
    id: string;
    vin: string;
    make: string | null;
    model: string | null;
    year: number | null;
  } | null;
  invoiceUrl: string | null;
  referenceNumber: string | null;
  notes: string | null;
  invoiceId?: string | null;
  invoiceNumber?: string | null;
  paymentDeadline?: string | null;
  paymentDate?: string | null;
  isGeneralCost?: boolean;
  isVehicleStageCost?: boolean;
  isInvoice?: boolean;
  costType?: string | null;
  category?: string | null;
  paymentStatus?: string | null; // due, overdue, partially_paid, paid
  invoiceStatus?: string | null;
}

interface Vehicle {
  id: string;
  vin: string;
  make: string | null;
  model: string | null;
  year: number | null;
  purchaseDate: Date | null;
  currentShippingStage: ShippingStage | null;
  customer: {
    id: string;
    name: string;
    email: string | null;
  } | null;
  shippingStage: {
    stage: ShippingStage;
    yard: { name: string } | null;
    etd: Date | null;
    eta: Date | null;
  } | null;
  _count: {
    documents: number;
    stageCosts: number;
  };
  invoices?: Array<{
    id: string;
    invoiceNumber: string;
    status: string;
  }>;
  createdAt: string;
}

interface GeneralCost {
  id: string;
  description: string;
  amount: string;
  currency: string;
  date: string;
  vendor: { id: string; name: string; email: string | null } | null;
  invoiceUrl: string | null;
  notes: string | null;
  createdAt: string;
  updatedAt: string;
}

interface Vendor {
  id: string;
  name: string;
  email: string | null;
}

export function FinancialOperationsView({
  currentUser,
}: FinancialOperationsViewProps) {
  const searchParams = useSearchParams();
  const sectionParam = searchParams.get("section");

  const getInitialSection = (): "invoices" | "transactions" | "vehicles" => {
    if (sectionParam === "transactions" || sectionParam === "vehicles") {
      return sectionParam;
    }
    return "invoices";
  };

  const [activeSection, setActiveSection] = useState<
    "invoices" | "transactions" | "vehicles"
  >(getInitialSection());

  // Transactions state
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [transactionsLoading, setTransactionsLoading] = useState(false);
  const [transactionTab, setTransactionTab] =
    useState<TransactionDirection>("INCOMING");
  const [typeFilter, setTypeFilter] = useState<string>("all");
  const [startDate, setStartDate] = useState("");
  const [endDate, setEndDate] = useState("");
  const [transactionDialogOpen, setTransactionDialogOpen] = useState(false);
  const [editingTransaction, setEditingTransaction] =
    useState<Transaction | null>(null);

  // Vehicles state
  const [vehicles, setVehicles] = useState<Vehicle[]>([]);
  const [vehiclesLoading, setVehiclesLoading] = useState(false);
  const [search, setSearch] = useState("");
  const [stageFilter, setStageFilter] = useState<string>("all");
  const [customerFilter, setCustomerFilter] = useState<string>("all");
  const [sortBy, setSortBy] = useState<string>("purchaseDate");
  const [sortOrder, setSortOrder] = useState<"asc" | "desc">("desc");
  const [documentsDialogOpen, setDocumentsDialogOpen] = useState(false);
  const [selectedVehicleDocuments, setSelectedVehicleDocuments] = useState<
    any[]
  >([]);
  const [selectedVehicleId, setSelectedVehicleId] = useState<string | null>(
    null,
  );

  // General costs state
  const [costs, setCosts] = useState<GeneralCost[]>([]);
  const [vendors, setVendors] = useState<Vendor[]>([]);
  const [costsLoading, setCostsLoading] = useState(false);
  const [costDialogOpen, setCostDialogOpen] = useState(false);
  const [editingCost, setEditingCost] = useState<GeneralCost | null>(null);
  const [costStartDate, setCostStartDate] = useState("");
  const [costEndDate, setCostEndDate] = useState("");
  const [formData, setFormData] = useState({
    description: "",
    amount: "",
    currency: "JPY",
    date: new Date().toISOString().split("T")[0],
    vendorId: "",
    invoiceUrl: "",
    notes: "",
  });

  // Fetch transactions
  useEffect(() => {
    if (activeSection === "transactions") {
      fetchTransactions();
    }
  }, [activeSection, transactionTab, typeFilter, startDate, endDate]);

  const fetchVehicles = useCallback(async () => {
    try {
      setVehiclesLoading(true);
      const params = new URLSearchParams();
      if (search) params.append("search", search);
      if (stageFilter !== "all") params.append("stage", stageFilter);
      if (customerFilter !== "all") params.append("customerId", customerFilter);

      const url = `/api/vehicles${params.toString() ? `?${params.toString()}` : ""}`;
      const response = await fetch(url);
      if (response.ok) {
        const data = await response.json();
        let vehiclesList = Array.isArray(data) ? data : [];

        // Sort vehicles
        vehiclesList.sort((a: Vehicle, b: Vehicle) => {
          let aValue: any;
          let bValue: any;

          if (sortBy === "purchaseDate") {
            aValue = a.purchaseDate ? new Date(a.purchaseDate).getTime() : 0;
            bValue = b.purchaseDate ? new Date(b.purchaseDate).getTime() : 0;
          } else if (sortBy === "eta") {
            aValue = a.shippingStage?.eta
              ? new Date(a.shippingStage.eta).getTime()
              : 0;
            bValue = b.shippingStage?.eta
              ? new Date(b.shippingStage.eta).getTime()
              : 0;
          } else {
            return 0;
          }

          if (sortOrder === "asc") {
            return aValue - bValue;
          } else {
            return bValue - aValue;
          }
        });

        setVehicles(vehiclesList);
      } else {
        const errorData = await response.json().catch(() => ({}));
        console.error(
          "Failed to fetch vehicles:",
          response.status,
          response.statusText,
          errorData,
        );
        setVehicles([]);
      }
    } catch (error) {
      console.error("Error fetching vehicles:", error);
      setVehicles([]);
    } finally {
      setVehiclesLoading(false);
    }
  }, [search, stageFilter, customerFilter, sortBy, sortOrder]);

  const handleViewDocuments = async (vehicleId: string) => {
    try {
      const response = await fetch(`/api/vehicles/${vehicleId}/documents`);
      if (response.ok) {
        const documents = await response.json();
        setSelectedVehicleDocuments(documents);
        setSelectedVehicleId(vehicleId);
        setDocumentsDialogOpen(true);
      } else {
        alert("Failed to fetch documents");
      }
    } catch (error) {
      console.error("Error fetching documents:", error);
      alert("Failed to fetch documents");
    }
  };

  // Fetch vehicles when section becomes active or filters change
  useEffect(() => {
    if (activeSection === "vehicles") {
      fetchVehicles();
    }
  }, [activeSection, fetchVehicles]);

  // Fetch general costs
  useEffect(() => {
    if (activeSection === "general-costs") {
      fetchCosts();
      fetchVendors();
    }
  }, [activeSection, costStartDate, costEndDate]);

  const fetchTransactions = async () => {
    try {
      setTransactionsLoading(true);
      const params = new URLSearchParams();
      params.append("direction", transactionTab);
      if (typeFilter !== "all") params.append("type", typeFilter);
      if (startDate) params.append("startDate", startDate);
      if (endDate) params.append("endDate", endDate);

      const response = await fetch(`/api/transactions?${params}`);
      if (response.ok) {
        const data = await response.json();
        setTransactions(data);
      }
    } catch (error) {
      console.error("Error fetching transactions:", error);
    } finally {
      setTransactionsLoading(false);
    }
  };

  const fetchCosts = async () => {
    try {
      setCostsLoading(true);
      const params = new URLSearchParams();
      if (costStartDate) params.append("startDate", costStartDate);
      if (costEndDate) params.append("endDate", costEndDate);

      const response = await fetch(`/api/general-costs?${params}`);
      if (response.ok) {
        const data = await response.json();
        setCosts(data);
      }
    } catch (error) {
      console.error("Error fetching general costs:", error);
    } finally {
      setCostsLoading(false);
    }
  };

  const fetchVendors = async () => {
    try {
      const response = await fetch("/api/vendors");
      if (response.ok) {
        const data = await response.json();
        setVendors(data);
      }
    } catch (error) {
      console.error("Error fetching vendors:", error);
    }
  };

  const handleOpenCostDialog = (cost?: GeneralCost) => {
    if (cost) {
      setEditingCost(cost);
      setFormData({
        description: cost.description,
        amount: cost.amount,
        currency: cost.currency,
        date: cost.date.split("T")[0],
        vendorId: cost.vendor?.id || "",
        invoiceUrl: cost.invoiceUrl || "",
        notes: cost.notes || "",
      });
    } else {
      setEditingCost(null);
      setFormData({
        description: "",
        amount: "",
        currency: "JPY",
        date: new Date().toISOString().split("T")[0],
        vendorId: "",
        invoiceUrl: "",
        notes: "",
      });
    }
    setCostDialogOpen(true);
  };

  const handleCloseCostDialog = () => {
    setCostDialogOpen(false);
    setEditingCost(null);
  };

  const handleSubmitCost = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const url = editingCost
        ? `/api/general-costs/${editingCost.id}`
        : "/api/general-costs";
      const method = editingCost ? "PATCH" : "POST";

      const response = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          description: formData.description,
          amount: parseFloat(formData.amount),
          currency: formData.currency,
          date: formData.date,
          vendorId: formData.vendorId || null,
          invoiceUrl: formData.invoiceUrl || null,
          notes: formData.notes || null,
        }),
      });

      if (response.ok) {
        fetchCosts();
        handleCloseCostDialog();
      } else {
        const error = await response.json();
        alert(error.error || "Failed to save general cost");
      }
    } catch (error) {
      console.error("Error saving general cost:", error);
      alert("Failed to save general cost");
    }
  };

  const handleDeleteCost = async (id: string) => {
    if (!confirm("Are you sure you want to delete this cost?")) return;

    try {
      const response = await fetch(`/api/general-costs/${id}`, {
        method: "DELETE",
      });

      if (response.ok) {
        fetchCosts();
      } else {
        alert("Failed to delete cost");
      }
    } catch (error) {
      console.error("Error deleting cost:", error);
      alert("Failed to delete cost");
    }
  };

  const typeLabels: Record<TransactionType, string> = {
    BANK_TRANSFER: "Bank Transfer",
    PAYPAL: "PayPal",
    CASH: "Cash",
    WISE: "Wise",
  };

  const stageLabels: Record<ShippingStage, string> = {
    PURCHASE: "Purchase",
    TRANSPORT: "Transport",
    REPAIR: "Repair",
    DOCUMENTS: "Documents",
    BOOKING: "Booking",
    SHIPPED: "Shipped",
    DHL: "DHL",
  };

  const stageColors: Record<ShippingStage, string> = {
    PURCHASE:
      "bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/20 dark:text-yellow-300 dark:border-yellow-800",
    TRANSPORT:
      "bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/20 dark:text-blue-300 dark:border-blue-800",
    REPAIR:
      "bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900/20 dark:text-purple-300 dark:border-purple-800",
    DOCUMENTS:
      "bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/20 dark:text-orange-300 dark:border-orange-800",
    BOOKING:
      "bg-cyan-100 text-cyan-700 border-cyan-200 dark:bg-cyan-900/20 dark:text-cyan-300 dark:border-cyan-800",
    SHIPPED:
      "bg-indigo-100 text-indigo-700 border-indigo-200 dark:bg-indigo-900/20 dark:text-indigo-300 dark:border-indigo-800",
    DHL: "bg-green-100 text-green-700 border-green-200 dark:bg-green-900/20 dark:text-green-300 dark:border-green-800",
  };

  const transactionTotal = transactions.reduce(
    (sum, t) => sum + parseFloat(t.amount),
    0,
  );

  const costTotal = costs.reduce((sum, c) => sum + parseFloat(c.amount), 0);

  const canViewVehicles =
    currentUser.role === UserRole.MANAGER ||
    currentUser.role === UserRole.ADMIN ||
    currentUser.role === UserRole.BACK_OFFICE_STAFF ||
    currentUser.role === UserRole.ACCOUNTANT;

  const canViewTransactions =
    currentUser.role === UserRole.MANAGER ||
    currentUser.role === UserRole.ADMIN ||
    currentUser.role === UserRole.ACCOUNTANT;

  const canViewGeneralCosts =
    currentUser.role === UserRole.MANAGER ||
    currentUser.role === UserRole.ADMIN ||
    currentUser.role === UserRole.ACCOUNTANT;

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between gap-4 flex-wrap">
        <div className="flex items-center gap-3">
          <span className="material-symbols-outlined text-4xl text-primary dark:text-[#D4AF37]">
            account_balance_wallet
          </span>
          <div>
            <h1 className="text-3xl font-bold text-gray-900 dark:text-white">
              Financial Operations
            </h1>
            <p className="text-muted-foreground">
              Manage invoices, transactions, vehicles, and costs in one place
            </p>
          </div>
        </div>
      </div>

      <Tabs
        value={activeSection}
        onValueChange={(v) => setActiveSection(v as typeof activeSection)}
        className="w-full"
      >
        <TabsList
          className={`h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground grid w-full max-w-md ${(() => {
            const visibleTabs =
              1 + [canViewTransactions, canViewVehicles].filter(Boolean).length;
            return visibleTabs === 3
              ? "grid-cols-3"
              : visibleTabs === 2
                ? "grid-cols-2"
                : "grid-cols-1";
          })()} mb-6`}
        >
          <TabsTrigger value="invoices">Invoices</TabsTrigger>
          {canViewTransactions && (
            <TabsTrigger value="transactions">Transactions</TabsTrigger>
          )}
          {canViewVehicles && (
            <TabsTrigger value="vehicles">Vehicles</TabsTrigger>
          )}
        </TabsList>

        <TabsContent value="invoices" className="mt-6">
          <CombinedInvoicesView currentUser={currentUser} />
        </TabsContent>

        {canViewTransactions && (
          <TabsContent value="transactions" className="mt-6">
            <Card>
              <CardHeader className="pb-4">
                <div className="flex items-center justify-between mb-4">
                  <CardTitle>Transactions</CardTitle>
                  <Button
                    onClick={() => setTransactionDialogOpen(true)}
                    className="inline-flex items-center gap-2"
                  >
                    <span className="material-symbols-outlined">add</span>
                    Add Transaction
                  </Button>
                </div>
                <div className="flex gap-2 border-b">
                  <button
                    onClick={() => setTransactionTab("INCOMING")}
                    className={`px-6 py-3 font-medium transition-colors relative ${
                      transactionTab === "INCOMING"
                        ? "text-primary"
                        : "text-muted-foreground hover:text-foreground"
                    }`}
                  >
                    Incoming Payments
                    {transactionTab === "INCOMING" && (
                      <span className="absolute bottom-0 left-0 right-0 h-0.5 bg-primary" />
                    )}
                  </button>
                  <button
                    onClick={() => setTransactionTab("OUTGOING")}
                    className={`px-6 py-3 font-medium transition-colors relative ${
                      transactionTab === "OUTGOING"
                        ? "text-primary"
                        : "text-muted-foreground hover:text-foreground"
                    }`}
                  >
                    Outgoing Costs
                    {transactionTab === "OUTGOING" && (
                      <span className="absolute bottom-0 left-0 right-0 h-0.5 bg-primary" />
                    )}
                  </button>
                </div>
              </CardHeader>
              <CardContent className="pt-6">
                <div className="flex gap-4 mb-6 flex-wrap items-end">
                  <div className="flex-1 min-w-[200px]">
                    <Label
                      htmlFor="start-date"
                      className="text-xs mb-1.5 block"
                    >
                      Start Date
                    </Label>
                    <Input
                      id="start-date"
                      type="date"
                      value={startDate}
                      onChange={(e) => setStartDate(e.target.value)}
                      className="w-full"
                    />
                  </div>
                  <div className="flex-1 min-w-[200px]">
                    <Label htmlFor="end-date" className="text-xs mb-1.5 block">
                      End Date
                    </Label>
                    <Input
                      id="end-date"
                      type="date"
                      value={endDate}
                      onChange={(e) => setEndDate(e.target.value)}
                      className="w-full"
                    />
                  </div>
                  <div className="min-w-[180px]">
                    <Label
                      htmlFor="type-filter"
                      className="text-xs mb-1.5 block"
                    >
                      Transaction Type
                    </Label>
                    <Select value={typeFilter} onValueChange={setTypeFilter}>
                      <SelectTrigger id="type-filter" className="w-full">
                        <SelectValue placeholder="All Types" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">All Types</SelectItem>
                        {Object.entries(typeLabels).map(([value, label]) => (
                          <SelectItem key={value} value={value}>
                            {label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                <div className="mb-6 p-5 bg-muted/50 rounded-lg border">
                  <div className="text-sm text-muted-foreground mb-1">
                    Total Amount
                  </div>
                  <div className="text-3xl font-bold">
                    {transactionTotal.toLocaleString()} JPY
                  </div>
                </div>

                {transactionsLoading ? (
                  <div className="text-center py-12">
                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                    <p className="mt-4 text-muted-foreground">
                      Loading transactions...
                    </p>
                  </div>
                ) : transactions.length === 0 ? (
                  <div className="text-center py-12">
                    <div className="flex flex-col items-center gap-3">
                      <span className="material-symbols-outlined text-5xl text-muted-foreground">
                        account_balance
                      </span>
                      <div>
                        <p className="text-lg font-medium text-foreground mb-1">
                          No transactions found
                        </p>
                        <p className="text-sm text-muted-foreground">
                          {transactionTab === "INCOMING"
                            ? "No incoming payments recorded yet"
                            : "No outgoing costs recorded yet"}
                        </p>
                      </div>
                      <Button
                        onClick={() => setTransactionDialogOpen(true)}
                        className="mt-2"
                      >
                        <span className="material-symbols-outlined text-lg mr-2">
                          add
                        </span>
                        Add {transactionTab === "INCOMING" ? "Payment" : "Cost"}
                      </Button>
                    </div>
                  </div>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="bg-gray-50 dark:bg-gray-800 border-b border-gray-300 dark:border-gray-600">
                          <th className="text-left text-sm font-semibold text-gray-900 dark:text-white p-3">
                            Date
                          </th>
                          <th className="text-left text-sm font-semibold text-gray-900 dark:text-white p-3">
                            Type
                          </th>
                          {transactionTab === "INCOMING" ? (
                            <>
                              <th className="text-left text-sm font-semibold text-gray-900 dark:text-white p-3">
                                Invoice #
                              </th>
                              <th className="text-left text-sm font-semibold text-gray-900 dark:text-white p-3">
                                Customer
                              </th>
                              <th className="text-left text-sm font-semibold text-gray-900 dark:text-white p-3">
                                Vehicle
                              </th>
                            </>
                          ) : (
                            <>
                              <th className="text-left text-sm font-semibold text-gray-900 dark:text-white p-3">
                                Vendor
                              </th>
                              <th className="text-left text-sm font-semibold text-gray-900 dark:text-white p-3">
                                Invoice Attachments
                              </th>
                            </>
                          )}
                          <th className="text-left text-sm font-semibold text-gray-900 dark:text-white p-3">
                            Description
                          </th>
                          <th className="text-left text-sm font-semibold text-gray-900 dark:text-white p-3">
                            Payment Status
                          </th>
                          <th className="text-right text-sm font-semibold text-gray-900 dark:text-white p-3">
                            Amount
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {transactions.map((transaction) => {
                          const formatDate = (
                            dateString: string | null | undefined,
                          ) => {
                            if (!dateString) return "—";
                            const date = new Date(dateString);
                            if (isNaN(date.getTime())) return "—";
                            return date.toLocaleDateString("en-US", {
                              year: "numeric",
                              month: "short",
                              day: "numeric",
                            });
                          };

                          const formatCurrency = (amount: string) => {
                            return new Intl.NumberFormat("ja-JP", {
                              style: "currency",
                              currency: transaction.currency || "JPY",
                              minimumFractionDigits: 0,
                              maximumFractionDigits: 0,
                            }).format(parseFloat(amount));
                          };

                          // Build description with vehicle info if available (only for outgoing)
                          let descriptionParts: string[] = [];
                          if (transaction.description) {
                            descriptionParts.push(transaction.description);
                          }

                          // Add vehicle info to description only for outgoing transactions
                          if (
                            transactionTab === "OUTGOING" &&
                            transaction.vehicle
                          ) {
                            const vehicleInfo = transaction.vehicle.year
                              ? `${transaction.vehicle.year} ${transaction.vehicle.make || ""} ${transaction.vehicle.model || ""} - ${transaction.vehicle.vin}`
                              : `${transaction.vehicle.make || ""} ${transaction.vehicle.model || ""} - ${transaction.vehicle.vin}`;
                            descriptionParts.push(vehicleInfo.trim());
                          }

                          // Add vendor info for outgoing transactions
                          if (
                            transactionTab === "OUTGOING" &&
                            transaction.vendor
                          ) {
                            descriptionParts.push(
                              `Vendor: ${transaction.vendor.name}`,
                            );
                          }

                          // Add category if available
                          if (transaction.category) {
                            descriptionParts.push(
                              `Category: ${transaction.category}`,
                            );
                          }

                          const fullDescription = descriptionParts.join("\n");

                          // Format vehicle display
                          const vehicleDisplay = transaction.vehicle
                            ? transaction.vehicle.year
                              ? `${transaction.vehicle.year} ${transaction.vehicle.make || ""} ${transaction.vehicle.model || ""} - ${transaction.vehicle.vin}`
                              : `${transaction.vehicle.make || ""} ${transaction.vehicle.model || ""} - ${transaction.vehicle.vin}`
                            : "—";

                          return (
                            <tr
                              key={transaction.id}
                              className="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors"
                            >
                              <td className="p-3 text-sm text-gray-900 dark:text-white">
                                {formatDate(transaction.date)}
                              </td>
                              <td className="p-3">
                                <span
                                  className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                    transactionTab === "INCOMING"
                                      ? "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"
                                      : "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300"
                                  }`}
                                >
                                  {transactionTab === "INCOMING" ? (
                                    <>
                                      <span className="material-symbols-outlined text-sm mr-1">
                                        payments
                                      </span>
                                      {typeLabels[transaction.type]}
                                    </>
                                  ) : (
                                    <>
                                      <span className="material-symbols-outlined text-sm mr-1">
                                        receipt
                                      </span>
                                      {typeLabels[transaction.type]}
                                    </>
                                  )}
                                </span>
                              </td>
                              {transactionTab === "INCOMING" ? (
                                <>
                                  <td className="p-3 text-sm font-mono text-gray-900 dark:text-white">
                                    {transaction.isInvoice ? (
                                      <Link
                                        href={`/dashboard/invoices/${transaction.invoiceId}`}
                                        className="text-primary hover:underline"
                                      >
                                        {transaction.invoiceNumber || "—"}
                                      </Link>
                                    ) : (
                                      transaction.invoiceNumber ||
                                      transaction.invoiceId ||
                                      "—"
                                    )}
                                  </td>
                                  <td className="p-3 text-sm text-gray-900 dark:text-white">
                                    {transaction.customer?.name ||
                                      transaction.customer?.email ||
                                      "N/A"}
                                  </td>
                                  <td className="p-3 text-sm text-gray-900 dark:text-white">
                                    {vehicleDisplay}
                                  </td>
                                </>
                              ) : (
                                <>
                                  <td className="p-3 text-sm text-gray-900 dark:text-white">
                                    {transaction.vendor?.name || "N/A"}
                                  </td>
                                  <td className="p-3 text-sm text-gray-900 dark:text-white">
                                    <div className="flex flex-col gap-1">
                                      {transaction.invoiceId && (
                                        <Link
                                          href={`/dashboard/invoices/${transaction.invoiceId}`}
                                          className="text-primary hover:underline text-xs"
                                        >
                                          {transaction.invoiceNumber ||
                                            "View Invoice"}
                                        </Link>
                                      )}
                                      {transaction.invoiceUrl && (
                                        <a
                                          href={transaction.invoiceUrl}
                                          target="_blank"
                                          rel="noopener noreferrer"
                                          className="text-primary hover:underline text-xs flex items-center gap-1"
                                        >
                                          <span className="material-symbols-outlined text-sm">
                                            link
                                          </span>
                                          Invoice Link
                                        </a>
                                      )}
                                      {!transaction.invoiceId &&
                                        !transaction.invoiceUrl && (
                                          <span className="text-muted-foreground text-xs">
                                            —
                                          </span>
                                        )}
                                    </div>
                                  </td>
                                </>
                              )}
                              <td className="p-3 text-sm text-gray-900 dark:text-white">
                                <div className="flex flex-col whitespace-pre-line">
                                  {fullDescription || "N/A"}
                                  {transaction.isGeneralCost && (
                                    <span className="text-xs text-muted-foreground mt-1">
                                      General Cost
                                    </span>
                                  )}
                                  {transaction.isVehicleStageCost && (
                                    <span className="text-xs text-muted-foreground mt-1">
                                      Vehicle Cost
                                    </span>
                                  )}
                                  {transaction.isInvoice && (
                                    <span className="text-xs text-muted-foreground mt-1">
                                      Invoice
                                    </span>
                                  )}
                                </div>
                              </td>
                              <td className="p-3 text-sm text-gray-900 dark:text-white">
                                {(() => {
                                  // For invoices, use the paymentStatus field
                                  if (
                                    transaction.isInvoice &&
                                    transaction.paymentStatus
                                  ) {
                                    const statusColors: Record<string, string> =
                                      {
                                        paid: "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",
                                        partially_paid:
                                          "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300",
                                        overdue:
                                          "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",
                                        due: "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",
                                      };
                                    const statusLabels: Record<string, string> =
                                      {
                                        paid: "Paid",
                                        partially_paid: "Partially Paid",
                                        overdue: "Overdue",
                                        due: "Due",
                                      };
                                    const status = transaction.paymentStatus;
                                    return (
                                      <div className="flex items-center gap-2">
                                        <span
                                          className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColors[status] || statusColors.due}`}
                                        >
                                          {statusLabels[status] || status}
                                        </span>
                                        {transaction.paymentDeadline && (
                                          <span className="text-xs text-muted-foreground">
                                            Due:{" "}
                                            {formatDate(
                                              transaction.paymentDeadline,
                                            )}
                                          </span>
                                        )}
                                        {transaction.paymentDate && (
                                          <span className="text-xs text-muted-foreground">
                                            Paid:{" "}
                                            {formatDate(
                                              transaction.paymentDate,
                                            )}
                                          </span>
                                        )}
                                      </div>
                                    );
                                  }

                                  // Parse paymentDate from notes if it's stored there (for regular transactions)
                                  let paymentDateFromNotes: string | null =
                                    null;
                                  if (
                                    !transaction.paymentDate &&
                                    transaction.notes
                                  ) {
                                    try {
                                      const notesData = JSON.parse(
                                        transaction.notes,
                                      );
                                      if (notesData.paymentDate) {
                                        paymentDateFromNotes =
                                          notesData.paymentDate;
                                      }
                                    } catch (e) {
                                      // Notes is not JSON, ignore
                                    }
                                  }

                                  const isPaid = !!(
                                    transaction.paymentDate ||
                                    paymentDateFromNotes
                                  );
                                  const paymentDate =
                                    transaction.paymentDate ||
                                    paymentDateFromNotes
                                      ? new Date(
                                          transaction.paymentDate ||
                                            paymentDateFromNotes!,
                                        )
                                      : null;
                                  const paymentDeadline =
                                    transaction.paymentDeadline
                                      ? new Date(transaction.paymentDeadline)
                                      : null;

                                  const handleMarkAsPaid = async () => {
                                    if (
                                      !confirm(
                                        "Mark this transaction as paid? This will set the payment date to today.",
                                      )
                                    ) {
                                      return;
                                    }

                                    try {
                                      // If this is a vehicle stage cost, update it via the vehicle stage cost API
                                      if (
                                        transaction.isVehicleStageCost &&
                                        transaction.vehicle?.id
                                      ) {
                                        // Extract the cost ID from the transaction ID
                                        const costId = transaction.id.replace(
                                          "vehicle-cost-",
                                          "",
                                        );
                                        const response = await fetch(
                                          `/api/vehicles/${transaction.vehicle.id}/costs/${costId}`,
                                          {
                                            method: "PATCH",
                                            headers: {
                                              "Content-Type":
                                                "application/json",
                                            },
                                            body: JSON.stringify({
                                              paymentDate:
                                                new Date().toISOString(),
                                            }),
                                          },
                                        );

                                        if (response.ok) {
                                          fetchTransactions();
                                        } else {
                                          const errorData = await response
                                            .json()
                                            .catch(() => ({}));
                                          alert(
                                            errorData.error ||
                                              "Failed to update transaction",
                                          );
                                        }
                                      } else {
                                        // For regular transactions, store paymentDate in notes as JSON
                                        let currentNotes: any = {};
                                        try {
                                          if (transaction.notes) {
                                            currentNotes = JSON.parse(
                                              transaction.notes,
                                            );
                                          }
                                        } catch (e) {
                                          // If notes is not JSON, treat it as plain text
                                          currentNotes = {
                                            originalNotes: transaction.notes,
                                          };
                                        }

                                        const updatedNotes = {
                                          ...currentNotes,
                                          paymentDate: new Date().toISOString(),
                                        };

                                        const response = await fetch(
                                          `/api/transactions/${transaction.id}`,
                                          {
                                            method: "PATCH",
                                            headers: {
                                              "Content-Type":
                                                "application/json",
                                            },
                                            body: JSON.stringify({
                                              notes:
                                                JSON.stringify(updatedNotes),
                                            }),
                                          },
                                        );

                                        if (response.ok) {
                                          fetchTransactions();
                                        } else {
                                          const errorData = await response
                                            .json()
                                            .catch(() => ({}));
                                          alert(
                                            errorData.error ||
                                              "Failed to update transaction",
                                          );
                                        }
                                      }
                                    } catch (error) {
                                      console.error(
                                        "Error updating transaction:",
                                        error,
                                      );
                                      alert("Failed to update transaction");
                                    }
                                  };

                                  return (
                                    <div className="flex items-center gap-2">
                                      <div className="flex flex-col">
                                        {isPaid && paymentDate ? (
                                          <>
                                            <span className="text-sm font-medium">
                                              {formatDate(
                                                (transaction.paymentDate ||
                                                  paymentDateFromNotes)!,
                                              )}
                                            </span>
                                            <span className="text-xs text-muted-foreground">
                                              Paid
                                            </span>
                                          </>
                                        ) : paymentDeadline ? (
                                          <>
                                            <span className="text-sm">
                                              {formatDate(
                                                transaction.paymentDeadline,
                                              )}
                                            </span>
                                            <span className="text-xs text-muted-foreground">
                                              Due
                                            </span>
                                          </>
                                        ) : (
                                          <span className="text-muted-foreground">
                                            —
                                          </span>
                                        )}
                                      </div>
                                      <span
                                        className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                          isPaid
                                            ? "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"
                                            : "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300"
                                        }`}
                                      >
                                        {isPaid ? (
                                          <>
                                            <span className="material-symbols-outlined text-xs mr-1">
                                              check_circle
                                            </span>
                                            Paid
                                          </>
                                        ) : (
                                          <>
                                            <span className="material-symbols-outlined text-xs mr-1">
                                              schedule
                                            </span>
                                            Pending
                                          </>
                                        )}
                                      </span>
                                      {!isPaid && (
                                        <Button
                                          variant="ghost"
                                          size="sm"
                                          onClick={handleMarkAsPaid}
                                          className="h-7 text-xs"
                                          title="Mark as paid"
                                        >
                                          <span className="material-symbols-outlined text-sm">
                                            check
                                          </span>
                                        </Button>
                                      )}
                                    </div>
                                  );
                                })()}
                              </td>
                              <td className="p-3 text-right text-sm font-medium text-gray-900 dark:text-white">
                                {formatCurrency(transaction.amount)}
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                )}
              </CardContent>
            </Card>

            <AddTransactionDialog
              open={transactionDialogOpen}
              onOpenChange={(open) => {
                setTransactionDialogOpen(open);
                if (!open) {
                  setEditingTransaction(null);
                }
              }}
              onSuccess={() => {
                fetchTransactions();
                setEditingTransaction(null);
              }}
              defaultDirection={transactionTab}
              transaction={editingTransaction}
            />
          </TabsContent>
        )}

        {canViewVehicles && (
          <TabsContent value="vehicles" className="mt-6">
            <Card>
              <CardHeader className="pb-4">
                <div className="flex items-center justify-between">
                  <CardTitle>Vehicle Database</CardTitle>
                  <Link href="/dashboard/vehicles/new">
                    <Button className="inline-flex items-center gap-2">
                      <span className="material-symbols-outlined">add</span>
                      Add Vehicle
                    </Button>
                  </Link>
                </div>
              </CardHeader>
              <CardContent className="pt-6">
                <div className="flex gap-4 mb-6 flex-wrap items-end">
                  <div className="flex-1 min-w-[250px]">
                    <Label
                      htmlFor="vehicle-search"
                      className="text-xs mb-1.5 block"
                    >
                      Search
                    </Label>
                    <Input
                      id="vehicle-search"
                      type="text"
                      placeholder="Search by VIN, make, or model..."
                      value={search}
                      onChange={(e) => setSearch(e.target.value)}
                      onKeyDown={(e) => e.key === "Enter" && fetchVehicles()}
                      className="w-full"
                    />
                  </div>
                  <div className="min-w-[180px]">
                    <Label
                      htmlFor="stage-filter"
                      className="text-xs mb-1.5 block"
                    >
                      Stage
                    </Label>
                    <Select value={stageFilter} onValueChange={setStageFilter}>
                      <SelectTrigger id="stage-filter" className="w-full">
                        <SelectValue placeholder="All Stages" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">All Stages</SelectItem>
                        {Object.entries(stageLabels).map(([value, label]) => (
                          <SelectItem key={value} value={value}>
                            {label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="min-w-[180px]">
                    <Label htmlFor="sort-by" className="text-xs mb-1.5 block">
                      Sort By
                    </Label>
                    <Select value={sortBy} onValueChange={setSortBy}>
                      <SelectTrigger id="sort-by" className="w-full">
                        <SelectValue placeholder="Sort by" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="purchaseDate">
                          Purchase Date
                        </SelectItem>
                        <SelectItem value="eta">ETA</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="min-w-[140px]">
                    <Label
                      htmlFor="sort-order"
                      className="text-xs mb-1.5 block"
                    >
                      Order
                    </Label>
                    <Select
                      value={sortOrder}
                      onValueChange={(v) => setSortOrder(v as "asc" | "desc")}
                    >
                      <SelectTrigger id="sort-order" className="w-full">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="desc">Descending</SelectItem>
                        <SelectItem value="asc">Ascending</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <Button onClick={fetchVehicles} className="h-10">
                    <span className="material-symbols-outlined text-sm mr-2">
                      search
                    </span>
                    Search
                  </Button>
                </div>

                {vehiclesLoading ? (
                  <div className="text-center py-12">
                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                    <p className="mt-4 text-muted-foreground">
                      Loading vehicles...
                    </p>
                  </div>
                ) : vehicles.length === 0 ? (
                  <div className="text-center py-12">
                    <div className="flex flex-col items-center gap-3">
                      <span className="material-symbols-outlined text-5xl text-muted-foreground">
                        directions_car
                      </span>
                      <div>
                        <p className="text-lg font-medium text-foreground mb-1">
                          No vehicles found
                        </p>
                        <p className="text-sm text-muted-foreground">
                          {search || stageFilter !== "all"
                            ? "Try adjusting your filters"
                            : "Get started by adding your first vehicle"}
                        </p>
                      </div>
                      {!search && stageFilter === "all" && (
                        <Link href="/dashboard/vehicles/new">
                          <Button className="mt-2">
                            <span className="material-symbols-outlined text-lg mr-2">
                              add
                            </span>
                            Add Vehicle
                          </Button>
                        </Link>
                      )}
                    </div>
                  </div>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="border-b">
                          <th className="text-left py-3 px-4 font-semibold text-sm">
                            VIN
                          </th>
                          <th className="text-left py-3 px-4 font-semibold text-sm">
                            Vehicle
                          </th>
                          <th className="text-left py-3 px-4 font-semibold text-sm">
                            Customer
                          </th>
                          <th className="text-left py-3 px-4 font-semibold text-sm">
                            Stage
                          </th>
                          <th className="text-left py-3 px-4 font-semibold text-sm">
                            Purchase Date
                          </th>
                          <th className="text-left py-3 px-4 font-semibold text-sm">
                            ETA
                          </th>
                          <th className="text-left py-3 px-4 font-semibold text-sm">
                            Yard
                          </th>
                          <th className="text-left py-3 px-4 font-semibold text-sm">
                            Documents
                          </th>
                          <th className="text-left py-3 px-4 font-semibold text-sm">
                            Costs
                          </th>
                          <th className="text-left py-3 px-4 font-semibold text-sm">
                            Invoice
                          </th>
                          <th className="text-left py-3 px-4 font-semibold text-sm">
                            Actions
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {vehicles.map((vehicle) => (
                          <tr
                            key={vehicle.id}
                            className="border-b hover:bg-muted/30 transition-colors"
                          >
                            <td className="py-3 px-4 font-mono text-sm">
                              {vehicle.vin}
                            </td>
                            <td className="py-3 px-4">
                              {vehicle.make} {vehicle.model} {vehicle.year}
                            </td>
                            <td className="py-3 px-4">
                              {vehicle.customer?.name || "N/A"}
                            </td>
                            <td className="py-4 px-4">
                              {vehicle.currentShippingStage ? (
                                <span
                                  className={`px-2.5 py-1 rounded-md text-xs font-medium border ${stageColors[vehicle.currentShippingStage]}`}
                                >
                                  {stageLabels[vehicle.currentShippingStage]}
                                </span>
                              ) : (
                                <span className="text-sm text-muted-foreground">
                                  N/A
                                </span>
                              )}
                            </td>
                            <td className="py-4 px-4">
                              <div className="text-sm">
                                {vehicle.purchaseDate
                                  ? new Date(
                                      vehicle.purchaseDate,
                                    ).toLocaleDateString()
                                  : "N/A"}
                              </div>
                            </td>
                            <td className="py-4 px-4">
                              <div className="text-sm">
                                {vehicle.shippingStage?.eta
                                  ? new Date(
                                      vehicle.shippingStage.eta,
                                    ).toLocaleDateString()
                                  : "N/A"}
                              </div>
                            </td>
                            <td className="py-4 px-4">
                              <div className="text-sm">
                                {vehicle.shippingStage?.yard?.name || "N/A"}
                              </div>
                            </td>
                            <td className="py-4 px-4">
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() => handleViewDocuments(vehicle.id)}
                                disabled={vehicle._count.documents === 0}
                              >
                                <span className="material-symbols-outlined text-sm mr-1">
                                  description
                                </span>
                                {vehicle._count.documents}
                              </Button>
                            </td>
                            <td className="py-4 px-4">
                              <div className="text-sm font-medium">
                                {vehicle._count.stageCosts}
                              </div>
                            </td>
                            <td className="py-4 px-4">
                              {vehicle.invoices &&
                              vehicle.invoices.length > 0 ? (
                                <Link
                                  href={`/dashboard/invoices/${vehicle.invoices[0].id}`}
                                  className="text-sm text-primary hover:underline font-medium"
                                >
                                  {vehicle.invoices[0].invoiceNumber}
                                </Link>
                              ) : vehicle.customer ? (
                                <Link
                                  href={`/dashboard/invoices/new?vehicleId=${vehicle.id}&customerId=${vehicle.customer.id}`}
                                  className="text-sm text-primary hover:underline font-medium"
                                >
                                  Create
                                </Link>
                              ) : (
                                <span className="text-sm text-muted-foreground">
                                  N/A
                                </span>
                              )}
                            </td>
                            <td className="py-4 px-4">
                              <Link
                                href={`/dashboard/vehicles/${vehicle.id}`}
                                className="text-sm text-primary hover:underline font-medium"
                              >
                                View
                              </Link>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        )}
      </Tabs>

      {/* Documents Dialog */}
      <Dialog open={documentsDialogOpen} onOpenChange={setDocumentsDialogOpen}>
        <DialogContent className="max-w-3xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Vehicle Documents</DialogTitle>
            <DialogDescription>
              Download documents for this vehicle
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-2">
            {selectedVehicleDocuments.length === 0 ? (
              <p className="text-center py-8 text-muted-foreground">
                No documents available
              </p>
            ) : (
              selectedVehicleDocuments.map((doc) => (
                <div
                  key={doc.id}
                  className="flex items-center justify-between p-4 border rounded-lg hover:bg-muted/50"
                >
                  <div className="flex-1">
                    <p className="font-medium">{doc.name}</p>
                    {doc.category && (
                      <p className="text-sm text-muted-foreground">
                        Category: {doc.category}
                      </p>
                    )}
                    {doc.description && (
                      <p className="text-sm text-muted-foreground mt-1">
                        {doc.description}
                      </p>
                    )}
                  </div>
                  <div className="flex gap-2">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => window.open(doc.fileUrl, "_blank")}
                    >
                      <span className="material-symbols-outlined text-sm mr-1">
                        download
                      </span>
                      Download
                    </Button>
                  </div>
                </div>
              ))
            )}
          </div>
          <div className="flex gap-2 mt-4">
            <Button
              variant="outline"
              onClick={() => {
                // Download all documents
                selectedVehicleDocuments.forEach((doc) => {
                  window.open(doc.fileUrl, "_blank");
                });
              }}
              disabled={selectedVehicleDocuments.length === 0}
            >
              <span className="material-symbols-outlined text-sm mr-1">
                download
              </span>
              Download All
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
